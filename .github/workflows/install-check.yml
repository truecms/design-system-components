name: Install Check

on:
  push:
    branches:
      - main
      - master
      - 'release/**'
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  install-check:
    name: Node ${{ matrix.node-version }} install sweep
    runs-on: ubuntu-latest
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        node-version: ['22.x', 'lts/*']
    env:
      CI: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libc6 libnss3 libatk1.0-0 libatk-bridge2.0-0 libdrm2 libxkbcommon0 libxcomposite1 libxdamage1 libxfixes3 libgbm1 libpango-1.0-0 libcairo2 jq

      - name: Set up pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Enforce Node 22 baseline
        shell: bash
        run: |
          set -euo pipefail
          node_version="$(node -v)"
          echo "Active Node version: ${node_version}"
          major="${node_version#v}"
          major="${major%%.*}"
          if [ "${major}" -lt 22 ]; then
            echo '::error::Node 22 or newer is required for this workflow. Update the matrix entry or run `nvm use 22` locally before re-running.'
            exit 1
          fi

      - name: Fetch base branch for Changesets
        run: |
          set -euo pipefail
          event_name="${{ github.event_name }}"
          base_ref="${{ github.event.repository.default_branch }}"

          if [ "${event_name}" = "pull_request" ]; then
            base_ref="${{ github.event.pull_request.base.ref }}"
          fi

          if [ -z "${base_ref}" ]; then
            base_ref="master"
          fi

          echo "Fetching base ref: ${base_ref}"
          token="${{ secrets.GITHUB_TOKEN }}"
          repo="${{ github.repository }}"
          if [ -n "${token}" ]; then
            git remote set-url origin "https://x-access-token:${token}@github.com/${repo}.git"
          else
            git remote set-url origin "https://github.com/${repo}.git"
          fi
          git fetch --no-tags --prune origin "${base_ref}" || true
          if git show-ref --verify --quiet "refs/remotes/origin/${base_ref}"; then
            if git rev-parse --verify "${base_ref}" >/dev/null 2>&1; then
              git branch -f "${base_ref}" "origin/${base_ref}" || true
            else
              git branch "${base_ref}" "origin/${base_ref}" || true
            fi
          fi

          if [ "${base_ref}" != "master" ]; then
            echo "Fetching master for Changesets baseline"
            git fetch --no-tags --prune origin master || true
          fi

          if git show-ref --verify --quiet refs/remotes/origin/master; then
            if git rev-parse --verify master >/dev/null 2>&1; then
              git branch -f master origin/master || true
            else
              git branch master origin/master || true
            fi
          fi

      - name: Install dependencies
        run: |
          set -euo pipefail
          suffix="${{ matrix.node-version }}"
          safe="${suffix//\//-}"
          safe="${safe//\*/star}"
          export PERFORMANCE_OUTPUT_PATH="dist/reports/install-check-${safe}/performance.json"
          export PERFORMANCE_BASELINE_PATH="specs/001-already-began-task/fixtures/performance/baseline.json"
          export PERFORMANCE_MATRIX_LABEL="${safe}"

          start=$(date +%s)
          pnpm install --frozen-lockfile
          end=$(date +%s)

          node scripts/performance-metrics.js record --step install --duration "$((end - start))"

      - name: Build packages
        run: |
          set -euo pipefail
          suffix="${{ matrix.node-version }}"
          safe="${suffix//\//-}"
          safe="${safe//\*/star}"
          export PERFORMANCE_OUTPUT_PATH="dist/reports/install-check-${safe}/performance.json"
          export PERFORMANCE_BASELINE_PATH="specs/001-already-began-task/fixtures/performance/baseline.json"
          export PERFORMANCE_MATRIX_LABEL="${safe}"

          start=$(date +%s)
          pnpm run build
          end=$(date +%s)

          node scripts/performance-metrics.js record --step build --duration "$((end - start))"

      - name: Run tests
        run: |
          set -euo pipefail
          suffix="${{ matrix.node-version }}"
          safe="${suffix//\//-}"
          safe="${safe//\*/star}"
          export BUNDLE_PARITY_REPORT_PATH="dist/reports/install-check-${safe}/bundle-parity.json"
          export BUNDLE_PARITY_LOG_PATH="dist/reports/install-check-${safe}/bundle-parity.log"
          export PA11Y_REPORT_DIR="dist/reports/install-check-${safe}/a11y"
          export PERFORMANCE_OUTPUT_PATH="dist/reports/install-check-${safe}/performance.json"
          export PERFORMANCE_BASELINE_PATH="specs/001-already-began-task/fixtures/performance/baseline.json"
          export PERFORMANCE_MATRIX_LABEL="${safe}"

          start=$(date +%s)
          pnpm run test
          end=$(date +%s)

          node scripts/performance-metrics.js record --step test --duration "$((end - start))"
        env:
          STRICT_CHANGELOG: 'false'

      - name: Build site distribution bundle
        run: |
          set -euo pipefail
          suffix="${{ matrix.node-version }}"
          safe="${suffix//\//-}"
          safe="${safe//\*/star}"
          export PERFORMANCE_OUTPUT_PATH="dist/reports/install-check-${safe}/performance.json"
          export PERFORMANCE_BASELINE_PATH="specs/001-already-began-task/fixtures/performance/baseline.json"
          export PERFORMANCE_MATRIX_LABEL="${safe}"

          start=$(date +%s)
          pnpm run build:site-dist
          end=$(date +%s)

          node scripts/performance-metrics.js record --step 'build:site-dist' --duration "$((end - start))"

      - name: Audit production dependencies
        run: |
          set -euo pipefail
          pnpm audit --prod --json > install-check-audit-report.json
          if [ "$(jq '.vulnerabilities | length' install-check-audit-report.json)" -gt 0 ]; then
            echo '::error::Vulnerabilities detected in production dependency graph'
            cat install-check-audit-report.json
            exit 1
          fi
        shell: bash

      - name: Verify package tarballs install cleanly
        run: |
          set -euo pipefail
          node <<'NODE'
          const { execSync } = require('child_process');
          const fs = require('fs');
          const os = require('os');
          const path = require('path');

          const workspace = process.env.GITHUB_WORKSPACE;
          const tarballDir = path.join(workspace, 'dist', 'tarballs');
          const runnerTemp = process.env.RUNNER_TEMP || os.tmpdir();

          process.stdout.write('::group::Packing workspace packages with pnpm\n');
          const { packWorkspaceTarballs } = require(path.join(
            workspace,
            'scripts',
            'pack-workspace-tarballs.js'
          ));
          const { tarballs, packages } = packWorkspaceTarballs({
            workspaceDir: workspace,
            destination: tarballDir,
            stdio: 'inherit'
          });
          process.stdout.write('::endgroup::\n');

          const tarballEntries = (packages && packages.length > 0
            ? packages
            : tarballs.map((tarball) => {
                const safeName = tarball.replace(/\.tgz$/, '');
                const parts = safeName.split('-');
                const version = parts.pop();
                const scopeAndName = parts.join('-');
                const pkgName = scopeAndName.startsWith('truecms-')
                  ? `@truecms/${scopeAndName.replace(/^truecms-/, '')}`
                  : scopeAndName;
                return {
                  name: pkgName,
                  version,
                  tarballFile: tarball,
                  tarballPath: path.join(tarballDir, tarball)
                };
              }));

          if (tarballEntries.length === 0) {
            throw new Error('No tarballs found to verify');
          }

          const installDir = path.join(
            runnerTemp,
            `install-all-tarballs-${Date.now().toString(36)}`
          );

          process.stdout.write(`::group::Installing aggregated tarballs in ${installDir}\n`);
          fs.rmSync(installDir, { recursive: true, force: true });
          fs.mkdirSync(installDir, { recursive: true });
          const installPackageJson = {
            name: 'verify-all-tarballs',
            private: true,
            version: '0.0.0',
            dependencies: {}
          };

          for (const entry of tarballEntries) {
            installPackageJson.dependencies[entry.name] = `file:${entry.tarballPath}`;
          }

          fs.writeFileSync(
            path.join(installDir, 'package.json'),
            JSON.stringify(installPackageJson, null, 2)
          );

          execSync('pnpm install --ignore-scripts', { cwd: installDir, stdio: 'inherit' });
          process.stdout.write('::endgroup::\n');

          const summary = tarballEntries.map((entry) => ({
            tarball: entry.tarballFile,
            package: entry.name,
            installDir: path.relative(workspace, installDir)
          }));

          fs.writeFileSync(
            path.join(tarballDir, 'install-check-pack-summary.json'),
            JSON.stringify(summary, null, 2)
          );
          NODE

      - name: Derive artifact suffix
        id: artifact-name
        run: |
          set -euo pipefail
          version="${{ matrix['node-version'] }}"
          safe="${version//\//-}"
          safe="${safe//\*/star}"
          echo "suffix=${safe}" >> "$GITHUB_OUTPUT"

      - name: Summarise performance metrics
        if: always()
        run: |
          set -euo pipefail
          suffix="${{ matrix.node-version }}"
          safe="${suffix//\//-}"
          safe="${safe//\*/star}"
          export PERFORMANCE_OUTPUT_PATH="dist/reports/install-check-${safe}/performance.json"
          export PERFORMANCE_BASELINE_PATH="specs/001-already-began-task/fixtures/performance/baseline.json"
          export PERFORMANCE_MATRIX_LABEL="${safe}"
          export PERFORMANCE_SUMMARY_PATH="dist/reports/install-check-${safe}/performance-summary.json"
          node scripts/performance-metrics.js finalize

      - name: Upload install-check artefacts
        if: ${{ always() && env.ACT != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: install-check-artifacts-${{ steps.artifact-name.outputs.suffix }}
          path: |
            install-check-audit-report.json
            dist/tarballs/install-check-pack-summary.json
            dist/reports/install-check-${{ steps.artifact-name.outputs.suffix }}/bundle-parity.json
            dist/reports/install-check-${{ steps.artifact-name.outputs.suffix }}/bundle-parity.log
            dist/reports/install-check-${{ steps.artifact-name.outputs.suffix }}/a11y/index.json
            dist/reports/install-check-${{ steps.artifact-name.outputs.suffix }}/a11y/*.json
            dist/reports/install-check-${{ steps.artifact-name.outputs.suffix }}/performance.json
            dist/reports/install-check-${{ steps.artifact-name.outputs.suffix }}/performance-summary.json
          if-no-files-found: ignore

      - name: Clean tarballs
        if: always()
        run: |
          rm -rf dist/tarballs dist/reports
          pnpm store prune

      - name: Write job summary
        if: always()
        shell: bash
        run: |
          suffix='${{ matrix.node-version }}'
          safe="${suffix//\//-}"; safe="${safe//\*/star}"
          {
            echo "## Install Check â€” ${{ matrix.node-version }}"
            echo
            echo "| Metric | Value |"
            echo "|---|---|"
            echo "| Status | ${{ job.status }} |"
            echo "| Node | ${{ matrix.node-version }} |"
            echo "| Branch | ${GITHUB_REF_NAME} |"
            echo
            echo "- Verified install, build, tests, audit, and bundle parity."
            echo "- Artifacts: dist/reports/install-check-${safe}/ and changesets/dry-run summaries (if present)."
          } >> "$GITHUB_STEP_SUMMARY"

  dry-run-release:
    name: Dry run release validation
    runs-on: ubuntu-latest
    needs: install-check
    timeout-minutes: 45
    env:
      CI: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure master branch fetched
        run: |
          set -euo pipefail
          token="${{ secrets.GITHUB_TOKEN }}"
          repo="${{ github.repository }}"
          if [ -n "${token}" ]; then
            git remote set-url origin "https://x-access-token:${token}@github.com/${repo}.git"
          else
            git remote set-url origin "https://github.com/${repo}.git"
          fi
          git fetch --no-tags --prune origin master || true
          if git show-ref --verify --quiet refs/remotes/origin/master; then
            git branch --force master origin/master 2>/dev/null || git branch master origin/master
          fi

      - name: Set up pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Set up Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Enforce Node 22 baseline
        shell: bash
        run: |
          set -euo pipefail
          node_version="$(node -v)"
          echo "Active Node version: ${node_version}"
          major="${node_version#v}"
          major="${major%%.*}"
          if [ "${major}" -lt 22 ]; then
            echo '::error::Node 22 or newer is required for this workflow. Update the matrix entry or run `nvm use 22` locally before re-running.'
            exit 1
          fi

      - name: Install dependencies
        run: |
          set -euo pipefail
          export PERFORMANCE_OUTPUT_PATH="dist/reports/dry-run/performance.json"
          export PERFORMANCE_BASELINE_PATH="specs/001-already-began-task/fixtures/performance/baseline.json"
          export PERFORMANCE_MATRIX_LABEL="dry-run"

          start=$(date +%s)
          pnpm install --frozen-lockfile
          end=$(date +%s)

          node scripts/performance-metrics.js record --step install --duration "$((end - start))"

      - name: Build packages
        run: |
          set -euo pipefail
          export PERFORMANCE_OUTPUT_PATH="dist/reports/dry-run/performance.json"
          export PERFORMANCE_BASELINE_PATH="specs/001-already-began-task/fixtures/performance/baseline.json"
          export PERFORMANCE_MATRIX_LABEL="dry-run"

          start=$(date +%s)
          pnpm run build
          end=$(date +%s)

          node scripts/performance-metrics.js record --step build --duration "$((end - start))"

      - name: Run tests
        run: |
          set -euo pipefail
          export BUNDLE_PARITY_REPORT_PATH="dist/reports/dry-run/bundle-parity.json"
          export BUNDLE_PARITY_LOG_PATH="dist/reports/dry-run/bundle-parity.log"
          export PA11Y_REPORT_DIR="dist/reports/dry-run/a11y"
          export PERFORMANCE_OUTPUT_PATH="dist/reports/dry-run/performance.json"
          export PERFORMANCE_BASELINE_PATH="specs/001-already-began-task/fixtures/performance/baseline.json"
          export PERFORMANCE_MATRIX_LABEL="dry-run"

          start=$(date +%s)
          pnpm run test
          end=$(date +%s)

          node scripts/performance-metrics.js record --step test --duration "$((end - start))"

      - name: Build site distribution bundle
        run: |
          set -euo pipefail
          export PERFORMANCE_OUTPUT_PATH="dist/reports/dry-run/performance.json"
          export PERFORMANCE_BASELINE_PATH="specs/001-already-began-task/fixtures/performance/baseline.json"
          export PERFORMANCE_MATRIX_LABEL="dry-run"

          start=$(date +%s)
          pnpm run build:site-dist
          end=$(date +%s)

          node scripts/performance-metrics.js record --step 'build:site-dist' --duration "$((end - start))"

      - name: Dry run publish with Changesets
        run: pnpm run release -- --dry-run

      - name: Generate Changesets summary (tolerant)
        shell: bash
        run: |
          set -euo pipefail
          # Changesets exits non-zero when packages changed without a changeset.
          # For dry-run validation we tolerate this and emit an empty summary
          # so downstream steps can continue without publishing.
          if pnpm changeset status --output changesets-summary.json; then
            echo "Generated changesets-summary.json"
          else
            echo '::warning::No changesets found (or packages changed without a changeset). Emitting empty summary for validation only.'
            echo '{}' > changesets-summary.json
          fi

      - name: Pack workspace tarballs for verification
        run: |
          set -euo pipefail
          node <<'NODE'
          const { execSync } = require('child_process');
          const fs = require('fs');
          const os = require('os');
          const path = require('path');

          const workspace = process.env.GITHUB_WORKSPACE;
          const tarballDir = path.join(workspace, 'dist', 'tarballs');
          const runnerTemp = process.env.RUNNER_TEMP || os.tmpdir();

          process.stdout.write('::group::Packing workspace packages with pnpm\n');
          const { packWorkspaceTarballs } = require(path.join(
            workspace,
            'scripts',
            'pack-workspace-tarballs.js'
          ));
          const { tarballs, packages } = packWorkspaceTarballs({
            workspaceDir: workspace,
            destination: tarballDir,
            stdio: 'inherit'
          });
          process.stdout.write('::endgroup::\n');

          const tarballEntries = (packages && packages.length > 0
            ? packages
            : tarballs.map((tarball) => {
                const safeName = tarball.replace(/\.tgz$/, '');
                const parts = safeName.split('-');
                const version = parts.pop();
                const scopeAndName = parts.join('-');
                const pkgName = scopeAndName.startsWith('truecms-')
                  ? `@truecms/${scopeAndName.replace(/^truecms-/, '')}`
                  : scopeAndName;
                return {
                  name: pkgName,
                  version,
                  tarballFile: tarball,
                  tarballPath: path.join(tarballDir, tarball)
                };
              }));

          if (tarballEntries.length === 0) {
            throw new Error('No tarballs found to verify');
          }

          const installDir = path.join(
            runnerTemp,
            `dry-run-all-tarballs-${Date.now().toString(36)}`
          );

          process.stdout.write(`::group::Installing aggregated tarballs in ${installDir}\n`);
          fs.rmSync(installDir, { recursive: true, force: true });
          fs.mkdirSync(installDir, { recursive: true });
          const installPackageJson = {
            name: 'dry-run-all-tarballs',
            private: true,
            version: '0.0.0',
            dependencies: {}
          };

          for (const entry of tarballEntries) {
            installPackageJson.dependencies[entry.name] = `file:${entry.tarballPath}`;
          }

          fs.writeFileSync(
            path.join(installDir, 'package.json'),
            JSON.stringify(installPackageJson, null, 2)
          );

          execSync('pnpm install --ignore-scripts', { cwd: installDir, stdio: 'inherit' });
          process.stdout.write('::endgroup::\n');

          const summary = tarballEntries.map((entry) => ({
            tarball: entry.tarballFile,
            package: entry.name,
            installDir: path.relative(workspace, installDir)
          }));

          fs.writeFileSync(
            path.join(tarballDir, 'pack-summary.json'),
            JSON.stringify(summary, null, 2)
          );
          NODE

      - name: Summarise performance metrics
        if: always()
        run: |
          set -euo pipefail
          export PERFORMANCE_OUTPUT_PATH="dist/reports/dry-run/performance.json"
          export PERFORMANCE_BASELINE_PATH="specs/001-already-began-task/fixtures/performance/baseline.json"
          export PERFORMANCE_MATRIX_LABEL="dry-run"
          export PERFORMANCE_SUMMARY_PATH="dist/reports/dry-run/performance-summary.json"
          node scripts/performance-metrics.js finalize

      - name: Upload dry-run artefacts
        if: ${{ always() && env.ACT != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: dry-run-release-artifacts
          path: |
            changesets-summary.json
            dist/tarballs/pack-summary.json
            dist/reports/dry-run/bundle-parity.json
            dist/reports/dry-run/bundle-parity.log
            dist/reports/dry-run/a11y/index.json
            dist/reports/dry-run/a11y/*.json
            dist/reports/dry-run/performance.json
            dist/reports/dry-run/performance-summary.json
          if-no-files-found: ignore

      - name: Clean tarballs
        if: always()
        run: |
          rm -rf dist/tarballs dist/reports
          pnpm store prune
